# Agent Handoff: Code Quality Fixes (Parallel Track B)

## Mission Overview

Fix all ruff linting warnings introduced by merging PR #10 into Phase 2 unified branch.

## Phase 3B: Code Quality Validation & Fixes (code-reviewer)

### Context

- **Current Branch**: `feat/phase2-smart-onboarding-unified` (post-merge)
- **Working Directory**: `/home/gerald/git/mycelium`
- **Pre-Merge Baseline**: 44 minor ruff warnings
- **Target**: 0 critical errors, same or fewer warnings

### Current Ruff Configuration

```toml
[tool.ruff]
target-version = "py310"
line-length = 120
indent-width = 4
extend-exclude = [
    "tests/docs/test_generated_snippets.py",
    "tests/docs/snippets/",
]

[tool.ruff.lint]
select = [
    "E",      # pycodestyle errors
    "W",      # pycodestyle warnings
    "F",      # pyflakes
    "I",      # isort
    "B",      # flake8-bugbear
    "C4",     # flake8-comprehensions
    "UP",     # pyupgrade
    "ARG",    # flake8-unused-arguments
    "SIM",    # flake8-simplify
    "PTH",    # flake8-use-pathlib
    "RET",    # flake8-return
    "N",      # pep8-naming
    "D",      # pydocstyle
]
ignore = [
    "D203",   # one-blank-line-before-class
    "D213",   # multi-line-summary-second-line
]
```

### Expected New Issues

#### 1. Import Sorting (isort)

**Files**: All modified files

**Likely Issues**:

- Unsorted imports in strategy module files
- Import groups not properly separated
- Third-party imports mixed with local imports

**Fix Strategy**:

```python
# Correct import order:
# 1. Future imports
from __future__ import annotations

# 2. Standard library
import json
import logging
from dataclasses import dataclass
from datetime import datetime
from enum import Enum
from pathlib import Path
from typing import Any

# 3. Third-party
import click
from pydantic import BaseModel, Field
from rich.console import Console

# 4. Local
from mycelium_onboarding.config.manager import ConfigManager
from mycelium_onboarding.deployment.strategy import (
    DeploymentPlanSummary,
    DetectedService,
)
```

#### 2. Missing Docstrings (pydocstyle)

**Files**: `mycelium_onboarding/deployment/strategy/*.py`

**Likely Issues**:

- New classes without docstrings
- New methods without docstrings
- Missing module-level docstrings

**Fix Strategy**:

```python
"""Service detection and strategy selection module.

This module provides intelligent service detection that can identify running
services on the system and determine whether to reuse them or create new ones.

Classes:
    ServiceDetector: Detects running services
    DetectedService: Represents a detected service
    ServiceStatus: Enum for service status
"""

class ServiceDetector:
    """Detects running services on the system.

    This class scans for PostgreSQL, Redis, and Temporal services using multiple
    detection methods including Docker, system processes, and network ports.

    Attributes:
        verbose: Enable verbose logging
    """

    def detect_all_services(self) -> list[DetectedService]:
        """Detect all supported services.

        Returns:
            List of detected services with their status and metadata.
        """
        pass
```

#### 3. Unused Imports/Variables

**Files**: All modified files

**Likely Issues**:

- Imports added but not used
- Variables assigned but never referenced
- Unused function arguments

**Fix Strategy**:

```python
# Remove unused imports
# from typing import Optional  # Remove if not used

# Prefix unused arguments with underscore
def handle_event(self, _event_type: str, data: dict[str, Any]) -> None:
    """Handle event with data only."""
    process(data)
```

#### 4. Pathlib Usage (PTH)

**Files**: Files with path operations

**Likely Issues**:

- Using `os.path` instead of `pathlib.Path`
- String concatenation for paths
- `os.makedirs` instead of `Path.mkdir`

**Fix Strategy**:

```python
# Before
import os
path = os.path.join(base, "file.txt")
if os.path.exists(path):
    os.makedirs(dirname, exist_ok=True)

# After
from pathlib import Path
path = base / "file.txt"
if path.exists():
    path.parent.mkdir(parents=True, exist_ok=True)
```

#### 5. Simplification Opportunities (SIM)

**Files**: All files with conditionals

**Likely Issues**:

- Unnecessary `else` after `return`
- Complex conditionals that can be simplified
- Redundant boolean comparisons

**Fix Strategy**:

```python
# Before
def check_status(service):
    if service.is_running():
        return True
    else:
        return False

# After
def check_status(service):
    return service.is_running()

# Before
if status == True:
    do_something()

# After
if status:
    do_something()
```

### Tasks

#### 1. Run Baseline Ruff Check

```bash
cd /home/gerald/git/mycelium
uv run ruff check . 2>&1 | tee ruff-post-merge.log
```

**Analysis**:

- Count total warnings/errors
- Identify new issues vs pre-merge baseline (44)
- Categorize by rule code (I, D, F, etc.)
- Prioritize critical errors vs warnings

#### 2. Auto-Fix Safe Issues

```bash
# Run auto-fix for safe corrections
uv run ruff check . --fix

# Review changes
git diff
```

**Auto-fixable Rules**:

- `I` (isort) - Import sorting
- `F401` - Unused imports
- `UP` - Python version upgrades
- Some `SIM` rules - Simplifications

#### 3. Fix Import Organization

**Priority**: High (affects all modified files)

```bash
# Check import issues specifically
uv run ruff check . --select I
```

**Manual Fixes**:

- Ensure `from __future__ import annotations` is first
- Group imports correctly
- Sort alphabetically within groups
- Remove unused imports

#### 4. Fix Missing Docstrings

**Priority**: High (new strategy module)

```bash
# Check docstring issues
uv run ruff check . --select D
```

**Manual Fixes**:

- Add module docstrings to all strategy files
- Add class docstrings with Google-style format
- Add method docstrings with Args/Returns sections
- Ensure docstrings follow D213 (multi-line second line)

#### 5. Fix Code Quality Issues

**Priority**: Medium

```bash
# Check all other rules
uv run ruff check . --select E,W,F,B,C4,ARG,SIM,PTH,RET,N
```

**Common Fixes**:

- Remove unused arguments or prefix with `_`
- Convert to pathlib where applicable
- Simplify boolean expressions
- Remove unnecessary `else` after `return`

#### 6. Run Full Ruff Validation

```bash
uv run ruff check .
```

**Success Criteria**:

- No critical errors
- Total warnings ≤ 44 (pre-merge baseline)
- All auto-fixable issues resolved

### Common Ruff Patterns to Apply

#### Pattern 1: Module Docstring Template

```python
"""[Module purpose - one line summary].

[Detailed description of what this module does, its main classes,
and how it fits into the larger system.]

Classes:
    ClassName: Brief description

Functions:
    function_name: Brief description

Examples:
    >>> detector = ServiceDetector()
    >>> services = detector.detect_all_services()
"""
```

#### Pattern 2: Google-Style Docstrings

```python
def create_deployment_plan(
    self,
    config: MyceliumConfig,
    detected_services: list[DetectedService],
) -> DeploymentPlanSummary:
    """Create a smart deployment plan based on detected services.

    Analyzes detected services and determines the optimal strategy for each:
    REUSE for compatible existing services, CREATE for new deployments, or
    ALONGSIDE for version conflicts.

    Args:
        config: Project configuration with service requirements
        detected_services: List of services detected on the system

    Returns:
        Deployment plan summary with strategy for each service

    Raises:
        ValueError: If config is invalid or missing required services

    Examples:
        >>> planner = ServiceDeploymentPlanner(config, services)
        >>> plan = planner.create_deployment_plan()
        >>> print(plan.services_to_reuse)
        ['postgresql', 'redis']
    """
```

#### Pattern 3: Import Organization

```python
"""Module docstring first."""

from __future__ import annotations  # Always first

import json  # Standard library
import logging
from dataclasses import dataclass
from datetime import datetime
from enum import Enum
from pathlib import Path
from typing import Any

import click  # Third-party
from pydantic import BaseModel, Field
from rich.console import Console

from mycelium_onboarding.config.manager import ConfigManager  # Local
from mycelium_onboarding.deployment.strategy import DetectedService
```

### Incremental Fix Strategy

1. **Run auto-fix first** - Let ruff handle safe fixes
1. **Fix import organization** - Foundation for clean code
1. **Add docstrings to strategy module** - New code needs docs
1. **Fix pathlib issues** - If any path operations need updating
1. **Fix simplification issues** - Clean up logic
1. **Run full validation** - Ensure all issues resolved

### Ruff Rules Priority

**Critical (Must Fix)**:

- `E` - Syntax errors
- `F` - Undefined names, unused imports
- `I` - Import sorting

**High Priority**:

- `D` - Missing docstrings (for public APIs)
- `N` - Naming conventions
- `B` - Likely bugs

**Medium Priority**:

- `SIM` - Simplifications
- `RET` - Return statement improvements
- `UP` - Upgrade to modern Python

**Low Priority (Can Skip)**:

- `ARG` - Unused arguments (may be intentional)
- Some `D` rules in tests

### Success Criteria

- ✅ No critical ruff errors
- ✅ All imports properly sorted
- ✅ All public classes/functions have docstrings
- ✅ Total warnings ≤ 44 (baseline)
- ✅ Auto-fixable issues resolved

### Handoff to Next Phase

Once code quality fixes are complete, coordinate with:

- **qa-expert**: Re-run tests to ensure no regressions
- **python-pro**: Ensure no conflicts with type fixes

### Notes

- Auto-fix is safe for most issues (I, F401, UP)
- Docstrings should follow Google style (convention = "google")
- Some warnings may be acceptable (document with inline comments)
- Tests can skip docstring requirements (configured in pyproject.toml)

______________________________________________________________________

## Coordination Metadata

- **Agent**: code-reviewer
- **Phase**: 3B of 5
- **Priority**: High
- **Estimated Duration**: 15-20 minutes
- **Dependencies**: Phase 1 (merge) must complete first
- **Parallel Track**: Yes (Track A runs simultaneously)
