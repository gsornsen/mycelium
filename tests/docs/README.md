# Documentation Code Snippet Testing

Automated testing framework for Python code snippets in markdown documentation.

## Overview

This framework extracts Python code blocks from markdown files and validates them to ensure documentation examples are correct and up-to-date.

## Components

### 1. Extraction Script

**Location**: `scripts/extract_doc_snippets.py`

Extracts Python code blocks from markdown files and generates pytest test files.

**Features**:
- Parses all ```` ```python ```` code blocks from markdown
- Validates syntax using Python's AST parser
- Analyzes imports and assignments
- Generates individual snippet files for inspection
- Creates pytest test file with auto-generated tests
- Produces detailed coverage reports

**Usage**:
```bash
# Extract snippets and generate tests
python scripts/extract_doc_snippets.py

# With detailed report
python scripts/extract_doc_snippets.py --report

# Custom directories
python scripts/extract_doc_snippets.py \
    --docs-dir custom_docs \
    --output-dir tests/custom_snippets \
    --test-file tests/test_custom.py
```

### 2. Generated Tests

**Location**: `tests/docs/test_generated_snippets.py`

Auto-generated pytest file containing tests for each extracted snippet.

**DO NOT EDIT MANUALLY** - This file is regenerated by the extraction script.

**Test types**:
- **Syntax validation**: Verifies each snippet has valid Python syntax
- **Import validation**: Checks that imports can be compiled
- **Coverage test**: Ensures at least 85% of snippets are syntactically valid

### 3. Extracted Snippets

**Location**: `tests/docs/snippets/`

Individual Python files for each extracted snippet with metadata headers.

**Format**:
```python
# Source: path/to/file.md
# Line: 123
# Valid syntax: True
# Has imports: True
# Has assignments: True

# The actual code snippet follows
import example
...
```

## Running Tests

### Run All Snippet Tests

```bash
pytest tests/docs/test_generated_snippets.py -v
```

### Run Coverage Test Only

```bash
pytest tests/docs/test_generated_snippets.py::test_snippet_coverage -v
```

### Run Tests for Specific Doc File

```bash
# Example: test only wizard-guide.md snippets
pytest tests/docs/test_generated_snippets.py -k "wizard_guide" -v
```

### Generate Fresh Report

```bash
python scripts/extract_doc_snippets.py --report
```

## CI Integration

The GitHub Actions workflow `.github/workflows/docs.yml` automatically:

1. Runs on changes to:
   - Documentation files (`docs/**/*.md`)
   - Extraction script (`scripts/extract_doc_snippets.py`)
   - Test files (`tests/docs/**`)

2. Performs multiple checks:
   - **Test documentation**: Validates snippets across Python 3.10-3.13
   - **Lint documentation**: Runs ruff and mypy on extracted snippets
   - **Check coverage**: Reports snippet quality metrics
   - **Validate quality**: Enforces 85% valid syntax threshold

3. Creates artifacts:
   - Extracted snippet files
   - Coverage reports
   - Quality metrics

## Understanding Results

### Syntax Validation

Snippets must have valid Python syntax. Common reasons for invalid syntax:

- **Incomplete examples**: Intentional partial code for illustration
- **Pseudo-code**: Not meant to be executable Python
- **Type hints**: Advanced typing that may need imports
- **Async code**: `await` outside async function (expected in async examples)

### Compilation Validation

Some syntactically valid snippets may fail compilation due to:

- Missing imports (example assumes imports already present)
- Undefined variables (example builds on previous context)
- `await` outside async function (async examples)

These are **informational warnings**, not failures.

### Quality Threshold

Current threshold: **85% valid syntax**

This allows for:
- Intentional pseudo-code examples
- Partial snippets showing patterns
- Contextual examples that build on prior code

## Workflow for Documentation Updates

1. **Update documentation** with code examples
2. **Extract snippets**: `python scripts/extract_doc_snippets.py --report`
3. **Review report**: Check for unintended syntax errors
4. **Fix issues**: Update documentation if errors are unintentional
5. **Run tests**: `pytest tests/docs/test_generated_snippets.py -v`
6. **Commit**: Include both docs and test changes

## Configuration

### Quality Threshold

Edit `scripts/extract_doc_snippets.py`:

```python
# In generate_pytest_file method
# Change the threshold percentage (currently 85%)
assert valid_percentage >= 85, (...)
```

### Exclusion Patterns

To exclude certain documentation files:

```bash
python scripts/extract_doc_snippets.py --pattern "**/*.md" --exclude "**/CHANGELOG.md"
```

### Custom Code Block Markers

Currently extracts only ```` ```python ```` blocks. To support other markers, edit the pattern in `extract_from_file`:

```python
pattern = r"```python\n(.*?)```"  # Current
pattern = r"```(python|py)\n(.*?)```"  # Alternative
```

## Best Practices

### For Documentation Writers

1. **Use valid syntax**: Ensure code examples have correct Python syntax
2. **Add context comments**: Explain imports or setup if needed
3. **Test manually**: Run snippets before committing
4. **Mark pseudo-code**: Use different markers for non-executable examples
5. **Keep examples focused**: One concept per snippet

### For Reviewers

1. **Check test results**: Verify CI passes before merging
2. **Review coverage changes**: Note trends in snippet quality
3. **Validate errors**: Confirm syntax errors are intentional
4. **Test locally**: Run extraction script on new documentation

## Troubleshooting

### High Invalid Syntax Rate

**Problem**: More than 15% of snippets have syntax errors

**Solutions**:
- Review invalid snippet list in report
- Check for common patterns (missing colons, indentation)
- Verify code blocks use correct markdown syntax
- Consider if pseudo-code should use different markers

### Tests Fail in CI But Pass Locally

**Problem**: CI fails but local tests pass

**Causes**:
- Different Python versions
- Missing regeneration of test file
- Cached test results

**Solutions**:
```bash
# Clean and regenerate
rm -rf tests/docs/snippets/ tests/docs/test_generated_snippets.py
python scripts/extract_doc_snippets.py
pytest tests/docs/test_generated_snippets.py -v
```

### Specific Snippet Always Fails

**Problem**: One snippet consistently has issues

**Investigation**:
```bash
# Find the snippet file
ls tests/docs/snippets/ | grep "filename_snippet_N"

# View the snippet
cat tests/docs/snippets/filename_snippet_N.py

# Test it directly
python tests/docs/snippets/filename_snippet_N.py
```

### Extract Script Hangs

**Problem**: Extraction takes too long

**Causes**:
- Very large documentation files
- Complex regex patterns

**Solutions**:
- Process files in smaller batches
- Add timeout to file processing
- Use `--pattern` to limit scope

## Metrics and Reporting

### Coverage Report Format

```
Documentation Snippet Extraction Report
========================================

Total snippets extracted: 546
Valid Python syntax: 482 (88.3%)
Snippets with imports: 239
Snippets with assignments: 447

Snippets by file:
  api/registry-api.md: 36 snippet(s)
  deployment-guide.md: 18 snippet(s)
  ...

Invalid snippets (64):
  api/registry-api.md:100 - expected ':' (<unknown>, line 15)
  ...
```

### Key Metrics

- **Total snippets**: All Python code blocks found
- **Valid syntax**: Percentage that parse correctly
- **With imports**: Snippets that import modules
- **With assignments**: Snippets that assign variables

### Quality Gates

CI enforces these quality gates:

1. **Syntax validation**: â‰¥85% must have valid syntax
2. **Extraction success**: Script must complete without errors
3. **Type checking**: Extraction script passes mypy strict mode
4. **Code style**: Extraction script passes ruff checks

## Future Enhancements

Potential improvements to the framework:

1. **Execution testing**: Actually run code snippets in isolated environment
2. **Dependency detection**: Identify required packages
3. **Context linking**: Track snippets that build on each other
4. **Auto-fixing**: Suggest fixes for common syntax errors
5. **Interactive mode**: Review and fix snippets interactively
6. **Snippet tagging**: Mark snippets as executable, pseudo-code, etc.
7. **Performance testing**: Benchmark snippet execution time
8. **Security scanning**: Check for insecure patterns in examples

## Related Documentation

- [Testing Guide](../../docs/testing-guide.md)
- [Documentation Guidelines](../../docs/documentation-guide.md)
- [CI/CD Pipeline](../../docs/ci-cd.md)
