# Agent Handoff: Test Suite Validation

## Mission Overview

Validate test suite after merge and coordinate fix efforts for any test failures.

## Phase 2 & 4: Test Validation (qa-expert)

### Context

- **Current Branch**: `feat/phase2-smart-onboarding-unified` (post-merge)
- **Working Directory**: `/home/gerald/git/mycelium`
- **Pre-Merge Baseline**: 585 passed, 42 skipped
- **Target**: All tests passing, no new failures

### Test Configuration

```toml
[tool.pytest.ini_options]
minversion = "7.0"
addopts = ["-ra", "--strict-markers", "--strict-config", "--showlocals"]
testpaths = ["tests"]
markers = [
    "benchmark: marks tests as benchmarks",
    "slow: marks tests as slow",
    "integration: marks tests as integration tests",
    "asyncio: marks tests as async tests",
]
asyncio_mode = "auto"
```

## Phase 2: Initial Test Validation (Post-Merge)

### Tasks

#### 1. Run Complete Unit Test Suite

```bash
cd /home/gerald/git/mycelium
uv run pytest tests/unit/ -v --tb=short 2>&1 | tee test-post-merge.log
```

**Collect Metrics**:

- Total tests run
- Tests passed
- Tests failed (NEW)
- Tests skipped
- Execution time

#### 2. Identify New Failures

**Compare against baseline**: 585 passed, 42 skipped

**Categorize failures**:

- Import errors (missing modules)
- Type errors (incompatible types)
- Logic errors (changed behavior)
- Fixture errors (test setup issues)

#### 3. Analyze Failure Patterns

**Expected failure categories**:

**A. Strategy Module Import Failures**

```
ImportError: cannot import name 'DetectedService' from 'mycelium_onboarding.deployment.strategy'
```

- **Cause**: Missing `__init__.py` exports
- **Priority**: Critical
- **Owner**: devops-incident-responder (quick fix)

**B. Deployment Plan Test Failures**

```
AttributeError: 'DeploymentPlan' object has no attribute 'smart_plan'
```

- **Cause**: Test expectations don't match merged schema
- **Priority**: High
- **Owner**: qa-expert (update test)

**C. Generator Test Failures**

```
TypeError: DeploymentGenerator.__init__() got an unexpected keyword argument 'deployment_plan'
```

- **Cause**: Generator signature changed
- **Priority**: High
- **Owner**: qa-expert (update test)

**D. Detector Test Failures** (if tests exist)

```
AssertionError: Expected 3 services, got 2
```

- **Cause**: Detection logic refined
- **Priority**: Medium
- **Owner**: qa-expert (verify expected behavior)

#### 4. Create Failure Report

**Template**:

```markdown
## Test Failure Report - Post Merge

**Date**: [timestamp]
**Branch**: feat/phase2-smart-onboarding-unified
**Baseline**: 585 passed, 42 skipped
**Current**: [X] passed, [Y] failed, [Z] skipped

### New Failures

#### Critical (Blocking)
1. **test_module_imports** - ImportError in strategy module
   - File: tests/unit/deployment/test_strategy_imports.py
   - Error: Cannot import DetectedService
   - Root Cause: Missing __init__.py exports
   - Owner: devops-incident-responder
   - Fix: Add to strategy/__init__.py

2. [Additional critical failures]

#### High Priority
1. **test_deployment_plan_creation**
   - File: tests/unit/deployment/test_deploy_command.py
   - Error: AttributeError on smart_plan
   - Root Cause: Test needs update for merged schema
   - Owner: qa-expert
   - Fix: Update test assertions

### Actionable Items
- [ ] Fix strategy module exports
- [ ] Update deployment plan tests
- [ ] Update generator tests
- [ ] Verify detector behavior changes
```

#### 5. Coordinate Fixes

**Decision Tree**:

```
Test Failure
├─ Import Error?
│  └─ YES → devops-incident-responder (quick fix)
│      └─ Fix __init__.py exports
│      └─ Re-run tests
│
├─ Type Error?
│  └─ YES → python-pro (coordination)
│      └─ Fix after type safety pass completes
│
├─ Logic Error?
│  └─ YES → qa-expert (owns)
│      └─ Analyze if test or code is wrong
│      └─ Update test OR flag code issue
│
└─ Fixture Error?
   └─ YES → qa-expert (owns)
       └─ Update test fixtures
       └─ Ensure compatibility
```

## Phase 4: Final Test Validation (Post-Fixes)

### Tasks

#### 1. Re-run Full Test Suite

```bash
uv run pytest tests/unit/ -v --tb=short
```

**Success Criteria**:

- Tests passed ≥ 585 (baseline)
- Tests failed = 0
- Tests skipped ≈ 42 (may vary slightly)
- No new warnings

#### 2. Run Integration Tests (Optional)

```bash
uv run pytest tests/integration/ -v --tb=short -m "not slow"
```

**Purpose**:

- Verify end-to-end flows
- Check service detection in real scenarios
- Validate deployment plan generation

#### 3. Run Specific Test Categories

```bash
# Test deployment strategy module specifically
uv run pytest tests/unit/deployment/strategy/ -v

# Test deploy command integration
uv run pytest tests/unit/deployment/test_deploy_command.py -v

# Test generator with smart plan
uv run pytest tests/unit/deployment/test_generator.py -v
```

#### 4. Performance Baseline Check

```bash
# Check if merge affected test performance
uv run pytest tests/unit/ --durations=10
```

**Monitor**:

- Slowest tests
- Any new slow tests (> 1s)
- Total execution time vs baseline

#### 5. Create Final Validation Report

**Template**:

```markdown
## Final Test Validation Report

**Date**: [timestamp]
**Branch**: feat/phase2-smart-onboarding-unified
**Commit**: [merge commit hash]

### Test Results
- **Passed**: [X] (baseline: 585)
- **Failed**: 0 ✅
- **Skipped**: [Y] (baseline: 42)
- **Total Duration**: [Z]s

### Changes from Baseline
- New tests added: [count]
- Tests modified: [count]
- Tests removed: [count]

### Test Coverage
- Overall: [X]%
- Strategy module: [Y]%
- Deploy command: [Z]%

### Performance Impact
- Total duration change: [+/- X]%
- Slowest test: [name] ([time]s)
- No performance regressions detected ✅

### Validation Status
✅ All unit tests passing
✅ No new test failures
✅ Test coverage maintained
✅ No performance regressions
✅ Ready for commit
```

### Expected Test Files to Update

Based on PR #10 changes, these test files may need updates:

#### 1. Strategy Module Tests (NEW)

```bash
tests/unit/deployment/strategy/
├── __init__.py
├── test_detector.py          # Tests ServiceDetector
├── test_planner.py           # Tests ServiceDeploymentPlanner
├── test_service_strategy.py  # Tests strategy models
└── test_integration.py       # Integration tests
```

**If these don't exist**: They should be in PR #10. If missing, flag for follow-up.

#### 2. Deploy Command Tests (MODIFIED)

```bash
tests/unit/deployment/test_deploy_command.py
```

**Expected updates**:

- Test deployment plan with smart_plan field
- Test service detection integration
- Test strategy selection logic
- Test plan persistence/loading

#### 3. Generator Tests (MODIFIED)

```bash
tests/unit/deployment/test_generator.py
```

**Expected updates**:

- Test generator accepts deployment_plan parameter
- Test plan-aware configuration generation
- Test reused service handling

### Common Test Fixes

#### Fix 1: Import Errors

```python
# Add to mycelium_onboarding/deployment/strategy/__init__.py
"""Smart deployment strategy module."""

from .detector import DetectedService, ServiceDetector, ServiceStatus
from .planner import ServiceDeploymentPlanner
from .service_strategy import (
    DeploymentPlanSummary,
    ServiceDeploymentPlan,
    ServiceStrategy,
)

__all__ = [
    "DetectedService",
    "ServiceDetector",
    "ServiceStatus",
    "ServiceDeploymentPlanner",
    "DeploymentPlanSummary",
    "ServiceDeploymentPlan",
    "ServiceStrategy",
]
```

#### Fix 2: Update Test Assertions

```python
# Before (Phase 2 only)
def test_create_plan():
    plan = create_deployment_plan(...)
    assert plan.new_services == ["postgres", "redis"]

# After (with smart plan)
def test_create_plan():
    plan = create_deployment_plan(...)
    assert plan.new_services == ["postgres", "redis"]
    assert plan.smart_plan is not None
    assert plan.smart_plan.services_to_create == ["postgres", "redis"]
```

#### Fix 3: Update Fixtures

```python
# Add smart_plan to deployment plan fixture
@pytest.fixture
def deployment_plan():
    return DeploymentPlan(
        plan_id="test-plan",
        new_services=["postgres"],
        reusable_services=["redis"],
        smart_plan=DeploymentPlanSummary(
            plan_id="test-plan",
            project_name="test",
            service_plans={
                "postgres": ServiceDeploymentPlan(...),
                "redis": ServiceDeploymentPlan(...),
            },
        ),
    )
```

### Success Criteria

- ✅ All unit tests passing (≥585 passed)
- ✅ No new test failures
- ✅ Test coverage maintained or improved
- ✅ No performance regressions
- ✅ All test categories validated

### Handoff Coordination

**After Phase 2 (Initial Validation)**: → Report failures to appropriate agents → Block Phase 4 until fixes complete

**After Phase 4 (Final Validation)**: → Approve for commit (devops-incident-responder) → Confirm CI readiness

### Notes

- Some test updates are expected (not failures)
- Focus on regression prevention
- Document any intentional behavior changes
- Flag any unexpected failures immediately

______________________________________________________________________

## Coordination Metadata

- **Agent**: qa-expert
- **Phase**: 2 & 4 of 5
- **Priority**: Critical
- **Estimated Duration**: 10 minutes (Phase 2), 5 minutes (Phase 4)
- **Dependencies**:
  - Phase 2: Depends on Phase 1 (merge)
  - Phase 4: Depends on Phase 3A & 3B (fixes)
- **Blocking**: Phase 3 & 5 depend on this
