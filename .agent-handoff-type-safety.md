# Agent Handoff: Type Safety Fixes (Parallel Track A)

## Mission Overview

Fix all mypy type errors introduced by merging PR #10 into Phase 2 unified branch.

## Phase 3A: Type Safety Validation & Fixes (python-pro)

### Context

- **Current Branch**: `feat/phase2-smart-onboarding-unified` (post-merge)
- **Working Directory**: `/home/gerald/git/mycelium`
- **Pre-Merge Baseline**: 43 non-blocking mypy errors
- **Target**: 0 blocking errors, same or fewer non-blocking errors

### Current Mypy Configuration

```toml
[tool.mypy]
python_version = "3.10"
strict = true
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = true
disallow_incomplete_defs = true
check_untyped_defs = true
no_implicit_optional = true
warn_redundant_casts = true
warn_unused_ignores = true
warn_no_return = true
warn_unreachable = true
strict_equality = true
```

### Expected New Type Issues

#### 1. Strategy Module Type Definitions

**Files**: `mycelium_onboarding/deployment/strategy/*.py`

**Likely Issues**:

- Missing return type annotations
- Untyped function parameters
- Missing type imports from `typing`
- Inconsistent Optional vs `| None` usage

**Fix Strategy**:

```python
# Before (likely in PR #10)
def detect_service(name):
    return service

# After
from typing import Optional
def detect_service(name: str) -> Optional[DetectedService]:
    return service
```

#### 2. DeploymentPlan Integration

**File**: `mycelium_onboarding/deployment/commands/deploy.py`

**Likely Issues**:

- Type mismatch in `smart_plan` field assignment
- Missing imports for strategy types
- Incompatible type annotations between Phase 1 and Phase 2

**Fix Strategy**:

```python
# Ensure proper imports
from mycelium_onboarding.deployment.strategy import (
    DeploymentPlanSummary,
    ServiceDeploymentPlan,
    ServiceStrategy,
)

# Ensure consistent field types
smart_plan: DeploymentPlanSummary | None = None
```

#### 3. Detector Integration

**File**: `mycelium_onboarding/deployment/commands/deploy.py`

**Likely Issues**:

- DetectedService type not imported
- ServiceStatus enum not imported
- Type mismatches in list comprehensions

**Fix Strategy**:

```python
# Add to imports (lines 45-49)
from mycelium_onboarding.deployment.strategy.detector import (
    DetectedService,
    ServiceDetector,
    ServiceStatus,
)
```

#### 4. Planner Integration

**File**: `mycelium_onboarding/deployment/commands/deploy.py`

**Likely Issues**:

- ServiceDeploymentPlanner constructor type mismatches
- Config parameter type incompatibilities

**Fix Strategy**:

```python
# Ensure planner import
from mycelium_onboarding.deployment.strategy.planner import ServiceDeploymentPlanner

# Verify constructor call (around line 775)
smart_planner = ServiceDeploymentPlanner(
    config=config,  # MyceliumConfig type
    detected_services=detected_services,  # list[DetectedService]
    prefer_reuse=True,  # bool
)
```

### Tasks

#### 1. Run Baseline Mypy Check

```bash
cd /home/gerald/git/mycelium
uv run mypy mycelium_onboarding 2>&1 | tee mypy-post-merge.log
```

**Analysis**:

- Count total errors
- Identify new errors vs pre-merge baseline (43)
- Categorize by file and error type
- Prioritize blocking vs non-blocking

#### 2. Fix Strategy Module Types

**Priority**: High (new files from PR #10)

```bash
# Check strategy module specifically
uv run mypy mycelium_onboarding/deployment/strategy/
```

**Common Fixes**:

- Add return type annotations to all functions
- Add parameter type annotations
- Import required types from typing module
- Use `| None` instead of `Optional` for consistency

#### 3. Fix Integration Types

**Priority**: High (modified files)

```bash
# Check deploy.py specifically
uv run mypy mycelium_onboarding/deployment/commands/deploy.py
```

**Common Fixes**:

- Add missing imports from strategy module
- Fix type mismatches in assignments
- Add type annotations to lambda functions
- Fix dict comprehension types

#### 4. Fix Generator Integration Types

**Priority**: Medium

```bash
# Check generator.py
uv run mypy mycelium_onboarding/deployment/generator.py
```

**Common Fixes**:

- Update generator constructor to accept DeploymentPlanSummary
- Add type annotations for plan parameter
- Fix conditional type checking

#### 5. Run Full Mypy Validation

```bash
uv run mypy mycelium_onboarding
```

**Success Criteria**:

- No blocking errors
- Total errors ≤ 43 (pre-merge baseline)
- All strategy module files pass strict type checking

### Common Type Patterns to Apply

#### Pattern 1: Service Type Annotations

```python
from typing import Optional
from mycelium_onboarding.deployment.strategy.detector import DetectedService, ServiceStatus

def detect_service(
    service_name: str,
    port: int | None = None
) -> DetectedService | None:
    """Detect a service."""
    return DetectedService(...)
```

#### Pattern 2: List Type Annotations

```python
def detect_all_services(self) -> list[DetectedService]:
    """Detect all available services."""
    services: list[DetectedService] = []
    return services
```

#### Pattern 3: Dict Type Annotations

```python
def create_plan(self) -> dict[str, ServiceDeploymentPlan]:
    """Create deployment plan."""
    plans: dict[str, ServiceDeploymentPlan] = {}
    return plans
```

#### Pattern 4: Optional Chain Handling

```python
# Use proper optional chaining
if plan.smart_plan is not None:
    service_plan = plan.smart_plan.get_service_plan(name)
    if service_plan is not None:
        return service_plan.connection_string
return None
```

### Incremental Fix Strategy

1. **Fix strategy module files first** (new code, highest risk)

   - `detector.py`
   - `planner.py`
   - `service_strategy.py`

1. **Fix deploy.py integration** (modified code)

   - Import statements
   - Type annotations on new methods
   - Type guards for optional fields

1. **Fix generator.py** (modified code)

   - Constructor parameter types
   - Plan type handling

1. **Run full suite** and fix remaining issues

### Type Checking Best Practices

1. **Always use explicit types** - no implicit `Any`
1. **Use `| None` over `Optional`** - modern Python syntax
1. **Add docstrings with types** - helps mypy inference
1. **Use type guards** - for optional handling
1. **Avoid bare except** - use specific exceptions

### Success Criteria

- ✅ All strategy module files pass mypy strict mode
- ✅ deploy.py passes mypy with no new errors
- ✅ generator.py passes mypy with no new errors
- ✅ Total mypy errors ≤ 43 (baseline)
- ✅ No blocking type errors remain

### Handoff to Next Phase

Once type fixes are complete, coordinate with:

- **qa-expert**: Re-run tests to ensure no regressions
- **code-reviewer**: Final validation before commit

### Notes

- Phase 2 branch uses modern type syntax (`| None`)
- PR #10 may use older syntax (`Optional`)
- Standardize to Phase 2 conventions
- Some errors may be false positives - add `# type: ignore[specific-error]` with justification

______________________________________________________________________

## Coordination Metadata

- **Agent**: python-pro
- **Phase**: 3A of 5
- **Priority**: High
- **Estimated Duration**: 15-20 minutes
- **Dependencies**: Phase 1 (merge) must complete first
- **Parallel Track**: Yes (Track B runs simultaneously)
